<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CoChat</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#10a37f">

<style>
body { margin:0; font-family: Arial, sans-serif; background-color: #2a2a2a; color: white; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; overflow-x:hidden;}
.container { width:94%; max-width:460px; height:100vh; background:#2a2a2a; border-radius:18px; display:flex; flex-direction:column; padding:10px; box-sizing:border-box; position:relative;}
h2,h3 { margin:4px 0; text-align:center;}
input { padding:7px; margin:3px 0; border-radius:8px; border:none; font-size:13px;}
button { padding:10px; border:none; border-radius:8px; background-color:#10a37f; color:white; font-size:14px; cursor:pointer;}
.back-button { position:absolute; top:8px; left:10px; font-size:18px; cursor:pointer; opacity:0.7;}
#messages { flex:1 1 auto; overflow-y:auto; margin:6px 0; display:flex; flex-direction:column; scroll-behavior:smooth;}
.message { max-width:75%; padding:7px 9px; border-radius:14px; margin:3px 0; font-size:13px; animation:fadeIn 0.2s ease;}
.mine { align-self:flex-end; background:white; color:black;}
.other { align-self:flex-start; background:#10a37f; color:white;}
.time { font-size:10px; opacity:0.6; margin-top:2px;}
@keyframes fadeIn { from { opacity:0; transform:translateY(4px);} to {opacity:1; transform:translateY(0);}}
#inputArea { display:flex; gap:4px; flex-shrink:0;}
#inputArea input { flex:1; border-radius:8px; padding:7px;}
#fileInputLabel { background-color:#10a37f; color:white; border-radius:8px; display:flex; align-items:center; justify-content:center; width:40px; cursor:pointer; font-size:18px;}
#callButton { background-color:#28a745; width:40px; font-size:18px; display:flex; justify-content:center; align-items:center;}
#fileInput { display:none;}
.chat-history { margin-top:8px; background:#1f1f1f; border-radius:10px; padding:6px; max-height:100px; overflow-y:auto; font-size:12px;}
.chat-item { padding:4px; cursor:pointer; border-bottom:1px solid #333;}
.chat-item:last-child { border-bottom:none;}
.chat-item:hover { background:#333;}
.footer { position:absolute; bottom:6px; width:100%; text-align:center; font-size:10px; opacity:0.4;}
@media (max-width: 600px) {
  input { font-size:16px; padding:12px;}
  button { font-size:16px; padding:14px;}
  .message { font-size:15px; padding:10px 14px;}
  #fileInputLabel, #callButton { width:52px; height:52px; font-size:22px;}
}
</style>
</head>
<body>

<div id="login" class="container">
  <h2>CoChat</h2>
  <input id="usernameInput" placeholder="–í–∞—à–µ –∏–º—è">
  <input id="roomInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã">
  <input id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="enterChat()">–í–æ–π—Ç–∏</button>
  <div class="chat-history" id="historyBox"></div>
  <div class="footer">MEZENCEV&CO</div>
</div>

<div id="chat" class="container" style="display:none;">
  <div class="back-button" onclick="goBack()">‚Üê</div>
  <h3 id="roomTitle"></h3>
  <div id="messages"></div>
  <div id="typingStatus" style="font-size:12px;opacity:0.6;height:16px;margin-left:4px;"></div>
  <div id="inputArea">
    <label id="fileInputLabel" for="fileInput">‚ûï</label>
    <input type="file" id="fileInput" accept="image/*,video/*">
    <input id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="userTyping()">
    <button id="callButton">üìû</button>
    <button onclick="sendMessage()">‚û§</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, remove, get, off, onValue, set } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA64EfxQkGhcCKnxAT_0k_3BTFt5wc6x-E",
  authDomain: "cochat-18c46.firebaseapp.com",
  databaseURL: "https://cochat-18c46-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cochat-18c46",
  storageBucket: "cochat-18c46.firebasestorage.app",
  messagingSenderId: "966021418904",
  appId: "1:966021418904:web:efdf644f1203088c4025ed"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

let currentRoom = "";
let username = "";
let currentListener = null;
let typingTimeout;

// ===== –ó–í–£–ö–ò =====
const sendSound = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
const receiveSound = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");
const correctPassword = "1234";
const FIVE_DAYS = 5 * 24 * 60 * 60 * 1000;

/* ===== –ò–°–¢–û–†–ò–Ø ===== */
function saveToHistory(room){ let history = JSON.parse(localStorage.getItem("chatHistory"))||[]; history=history.filter(r=>r!==room); history.unshift(room); if(history.length>5) history.pop(); localStorage.setItem("chatHistory",JSON.stringify(history)); renderHistory();}
function renderHistory(){ const box=document.getElementById("historyBox"); box.innerHTML=""; const history=JSON.parse(localStorage.getItem("chatHistory"))||[]; history.forEach(room=>{const div=document.createElement("div"); div.className="chat-item"; div.innerText=room; div.onclick=()=>{document.getElementById("roomInput").value=room;}; box.appendChild(div);}); }
renderHistory();

/* ===== –ù–ê–ó–ê–î ===== */
window.goBack=function(){ if(currentListener){ off(currentListener); currentListener=null; } document.getElementById("chat").style.display="none"; document.getElementById("login").style.display="flex"; document.getElementById("messages").innerHTML=""; }

/* ===== –í–•–û–î ===== */
window.enterChat = async function() {
  const room = document.getElementById("roomInput").value.trim();
  const password = document.getElementById("passwordInput").value;
  username = document.getElementById("usernameInput").value.trim();
  if(password!==correctPassword) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
  if(room===""||username==="") return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –∫–æ–º–Ω–∞—Ç—É");
  currentRoom=room; saveToHistory(room);

  const messagesRef = ref(database,"rooms/"+room+"/messages");
  currentListener = messagesRef;

  // –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø–µ—á–∞—Ç–∞–µ—Ç
  const typingRef = ref(database,"rooms/"+room+"/typing");
  onValue(typingRef,(snap)=>{
    const data = snap.val() || {};
    const usersTyping = Object.keys(data).filter(u => u!==username);
    const statusEl = document.getElementById("typingStatus");
    if(usersTyping.length>1) statusEl.innerText="–ù–µ—Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–µ—á–∞—Ç–∞—é—Ç...";
    else if(usersTyping.length===1) statusEl.innerText=usersTyping[0]+" –ø–µ—á–∞—Ç–∞–µ—Ç...";
    else statusEl.innerText="";
  });

  // –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  const snapshot = await get(messagesRef);
  if(snapshot.exists()){ const data=snapshot.val(); const keys=Object.keys(data); const lastMsg=data[keys[keys.length-1]]; if(Date.now()-lastMsg.timestamp>FIVE_DAYS){ for(const k of keys) await remove(ref(database,"rooms/"+room+"/messages/"+k)); } }

  document.getElementById("login").style.display="none";
  document.getElementById("chat").style.display="flex";
  document.getElementById("roomTitle").innerText=room;

  onChildAdded(messagesRef,(data)=>{
    const msgData = data.val();
    const key = data.key;
    if(msgData.user!==username){
      set(ref(database,"rooms/"+currentRoom+"/messages/"+key+"/readBy/"+username),true);
    }
    displayMessage(msgData,key);
  });

  // –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞
  onValue(messagesRef, async (snap)=>{
    const data = snap.val();
    if(!data) return;
    const keys = Object.keys(data);
    if(keys.length>500){ const excess=keys.length-500; for(let i=0;i<excess;i++){ await remove(ref(database,"rooms/"+room+"/messages/"+keys[i])); }}
  });

  // –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∑–≤–æ–Ω–∫–∏
  const callRef = ref(database,"rooms/"+room+"/call");
  onValue(callRef,(snap)=>{
    const callData = snap.val();
    if(callData && callData.to===username && !window.inCall){
      if(confirm(`${callData.from} –∑–≤–æ–Ω–∏—Ç! –ü—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫?`)){
        startCall(true,callData.from);
      } else {
        set(callRef,null);
      }
    }
  });
};

/* ===== –ü–û–ö–ê–ó –°–û–û–ë–©–ï–ù–ò–ô ===== */
function displayMessage(msgData,key){
  const msg=document.createElement("div");
  msg.className="message "+(msgData.user===username?"mine":"other");

  let readMark="";
  if(msgData.user===username){
    if(msgData.readBy && Object.keys(msgData.readBy).length>1) readMark="‚úî‚úî";
    else readMark="‚úî";
  }

  if(msgData.type==="file"){
    msg.innerHTML=`
      üìé <a href="${msgData.fileData}" download="${msgData.fileName}" style="color:inherit;text-decoration:underline;">
      –°–∫–∞—á–∞—Ç—å ${msgData.fileName}</a>
      <div class="time">${msgData.time} ${readMark}</div>
    `;
  } else {
    msg.innerHTML=`
      <div><strong>${msgData.user}</strong>: ${msgData.text}</div>
      <div class="time">${msgData.time} ${readMark}</div>
    `;
  }

  if(msgData.user!==username){
    set(ref(database,"rooms/"+currentRoom+"/messages/"+key+"/readBy/"+username),true);
    receiveSound.currentTime = 0; receiveSound.play();
  }

  const messagesBox=document.getElementById("messages");
  messagesBox.appendChild(msg);
  messagesBox.scrollTop=messagesBox.scrollHeight;
}

/* ===== –û–¢–ü–†–ê–í–ö–ê ===== */
window.sendMessage=function(){
  const input=document.getElementById("messageInput");
  if(input.value.trim()==="") return;

  const now=new Date();
  const timeString=now.getHours().toString().padStart(2,'0')+":"+now.getMinutes().toString().padStart(2,'0');

  push(ref(database,"rooms/"+currentRoom+"/messages"),{
    user:username,
    text:input.value,
    time:timeString,
    timestamp:Date.now(),
    readBy:{ [username]:true },
    type:"text"
  });

  input.value="";
  sendSound.currentTime=0; sendSound.play();
};

window.userTyping=function(){
  const typingRef=ref(database,"rooms/"+currentRoom+"/typing/"+username);
  set(typingRef,true);
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{ set(typingRef,null); },2000);
};

/* ===== –§–ê–ô–õ–´ –í –ë–ê–ó–£ (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ) ===== */
document.getElementById("fileInput").addEventListener("change",(e)=>{
  const file=e.target.files[0];
  if(!file) return;
  if(file.size>5*1024*1024){ alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 5MB)"); return; }

  const reader=new FileReader();
  reader.onload=function(event){
    push(ref(database,"rooms/"+currentRoom+"/messages"),{
      user:username,
      type:"file",
      fileName:file.name,
      fileData:event.target.result,
      time:new Date().toLocaleTimeString(),
      timestamp:Date.now(),
      readBy:{ [username]:true }
    });
  };
  reader.readAsDataURL(file);
  e.target.value="";
});

/* ===== WebRTC –∑–≤–æ–Ω–æ–∫ ===== */
const peerConnections={};
const config={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};
let localStream;
window.inCall=false;

async function startCall(isAnswer,peerName){
  if(!localStream) localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});
  const pc=new RTCPeerConnection(config);
  peerConnections[peerName]=pc;
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));

  pc.ontrack=(e)=>{ const audio=document.createElement("audio"); audio.srcObject=e.streams[0]; audio.autoplay=true; document.body.appendChild(audio); }

  pc.onicecandidate=(event)=>{ if(event.candidate) push(ref(database,"rooms/"+currentRoom+"/ice/"+peerName),event.candidate.toJSON()); };

  if(!isAnswer){
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    set(ref(database,"rooms/"+currentRoom+"/call"),{from:username,to:peerName,sdp:offer});
    window.inCall=true;
  } else {
    const callRef=ref(database,"rooms/"+currentRoom+"/call");
    const snap=await get(callRef);
    if(snap.exists()){
      const data=snap.val();
      await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
      const answer=await pc.createAnswer();
      await pc.setLocalDescription(answer);
      set(callRef,{from:username,to:data.from,sdp:answer});
      window.inCall=true;
    }
  }
}

/* ===== –ö–ù–û–ü–ö–ê –ó–í–û–ù–û–ö ===== */
document.getElementById("callButton").addEventListener("click",()=>{
  const peer=prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä–æ–º—É —Ö–æ—Ç–∏—Ç–µ –ø–æ–∑–≤–æ–Ω–∏—Ç—å:");
  if(peer && peer!==username) startCall(false,peer);
});
</script>

<script>
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>{ navigator.serviceWorker.register("/sw.js").then(()=>console.log("SW –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω")).catch(err=>console.log("–û—à–∏–±–∫–∞ SW:",err)); });
}
</script>

</body>
</html>
