<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CoChat</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background-color: #1e1e1e;
  color: white;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.container {
  width: 95%;
  max-width: 480px;
  height: 96vh;
  background: #2a2a2a;
  border-radius: 20px;
  display: flex;
  flex-direction: column;
  padding: 12px;
  box-sizing: border-box;
}

h2, h3 {
  margin: 5px 0;
  text-align: center;
}

input {
  padding: 8px;
  margin: 4px 0;
  border-radius: 8px;
  border: none;
  font-size: 13px;
}

button {
  padding: 8px;
  border: none;
  border-radius: 8px;
  background-color: #10a37f;
  color: white;
  font-size: 13px;
  cursor: pointer;
}

#messages {
  flex: 1;
  overflow-y: auto;
  margin: 8px 0;
  display: flex;
  flex-direction: column;
}

.message {
  max-width: 75%;
  padding: 8px 10px;
  border-radius: 15px;
  margin: 4px 0;
  font-size: 13px;
  animation: fadeIn 0.2s ease;
}

.mine {
  align-self: flex-end;
  background: white;
  color: black;
}

.other {
  align-self: flex-start;
  background: #10a37f;
  color: white;
}

.time {
  font-size: 10px;
  opacity: 0.6;
  margin-top: 3px;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

#inputArea {
  display: flex;
  gap: 5px;
}

#inputArea input {
  flex: 1;
}

#typingStatus {
  font-size: 11px;
  opacity: 0.7;
  min-height: 14px;
}

.chat-history {
  margin-top: 10px;
  background: #1f1f1f;
  border-radius: 10px;
  padding: 6px;
  max-height: 120px;
  overflow-y: auto;
  font-size: 12px;
}

.chat-item {
  padding: 4px;
  cursor: pointer;
  border-bottom: 1px solid #333;
}

.chat-item:last-child {
  border-bottom: none;
}

.chat-item:hover {
  background: #333;
}
</style>
</head>
<body>

<div id="login" class="container">
  <h2>CoChat</h2>
  <input id="usernameInput" placeholder="Ваше имя">
  <input id="roomInput" placeholder="Название комнаты">
  <input id="passwordInput" placeholder="Пароль">
  <button onclick="enterChat()">Войти</button>

  <div class="chat-history" id="historyBox"></div>
</div>

<div id="chat" class="container" style="display:none;">
  <h3 id="roomTitle"></h3>
  <div id="messages"></div>
  <div id="typingStatus"></div>
  <div id="inputArea">
    <input id="messageInput" placeholder="Сообщение...">
    <button onclick="sendMessage()">➤</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, onValue, remove } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA64EfxQkGhcCKnxAT_0k_3BTFt5wc6x-E",
  authDomain: "cochat-18c46.firebaseapp.com",
  databaseURL: "https://cochat-18c46-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cochat-18c46",
  storageBucket: "cochat-18c46.firebasestorage.app",
  messagingSenderId: "966021418904",
  appId: "1:966021418904:web:efdf644f1203088c4025ed"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

let currentRoom = "";
let username = "";
const correctPassword = "1234";

const usernameInput = document.getElementById("usernameInput");
const historyBox = document.getElementById("historyBox");

if(localStorage.getItem("username")) {
  usernameInput.value = localStorage.getItem("username");
}

loadHistory();

window.enterChat = function() {
  const room = document.getElementById("roomInput").value.trim();
  const password = document.getElementById("passwordInput").value;
  username = usernameInput.value.trim();

  if(password !== correctPassword) {
    alert("Неверный пароль");
    return;
  }

  if(room === "" || username === "") {
    alert("Введите имя и комнату");
    return;
  }

  localStorage.setItem("username", username);
  saveRoom(room);

  currentRoom = room;

  document.getElementById("login").style.display = "none";
  document.getElementById("chat").style.display = "flex";
  document.getElementById("roomTitle").innerText = room;

  const messagesRef = ref(database, "rooms/" + room);

  onChildAdded(messagesRef, (data) => {
    const msgData = data.val();
    displayMessage(msgData);
  });

  setupTyping();
};

function displayMessage(msgData) {
  const msg = document.createElement("div");
  msg.className = "message " + 
    (msgData.user === username ? "mine" : "other");

  msg.innerHTML = `
    <div><strong>${msgData.user}</strong>: ${msgData.text}</div>
    <div class="time">${msgData.time}</div>
  `;

  const messagesDiv = document.getElementById("messages");
  messagesDiv.appendChild(msg);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

window.sendMessage = function() {
  const input = document.getElementById("messageInput");
  if(input.value.trim() === "") return;

  const now = new Date();
  const timeString =
    now.getHours().toString().padStart(2,'0') + ":" +
    now.getMinutes().toString().padStart(2,'0');

  const messagesRef = ref(database, "rooms/" + currentRoom);

  push(messagesRef, {
    user: username,
    text: input.value,
    time: timeString
  });

  input.value = "";
  stopTyping();
};

function setupTyping() {
  const typingRef = ref(database, "typing/" + currentRoom + "/" + username);
  const statusDiv = document.getElementById("typingStatus");
  const input = document.getElementById("messageInput");

  input.addEventListener("input", () => {
    set(typingRef, true);
    setTimeout(() => remove(typingRef), 1000);
  });

  const roomTypingRef = ref(database, "typing/" + currentRoom);

  onValue(roomTypingRef, (snapshot) => {
    const data = snapshot.val();
    if(!data) {
      statusDiv.innerText = "";
      return;
    }

    const usersTyping = Object.keys(data)
      .filter(u => u !== username);

    if(usersTyping.length > 0) {
      statusDiv.innerText = usersTyping.join(", ") + " печатает...";
    } else {
      statusDiv.innerText = "";
    }
  });
}

function stopTyping() {
  const typingRef = ref(database, "typing/" + currentRoom + "/" + username);
  remove(typingRef);
}

function saveRoom(room) {
  let rooms = JSON.parse(localStorage.getItem("rooms")) || [];
  rooms = rooms.filter(r => r !== room);
  rooms.unshift(room);
  if(rooms.length > 5) rooms.pop();
  localStorage.setItem("rooms", JSON.stringify(rooms));
  loadHistory();
}

function loadHistory() {
  historyBox.innerHTML = "";
  const rooms = JSON.parse(localStorage.getItem("rooms")) || [];
  rooms.forEach(room => {
    const div = document.createElement("div");
    div.className = "chat-item";
    div.innerText = room;
    div.onclick = () => {
      document.getElementById("roomInput").value = room;
    };
    historyBox.appendChild(div);
  });
}
</script>

</body>
</html>
