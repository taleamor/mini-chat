<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CoChat</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#10a37f">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background-color: #2a2a2a; /* —Ç–µ–ø–µ—Ä—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º */
  color: white;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  overflow-x: hidden;
}

.container {
  width: 94%;
  max-width: 460px;
  height: 100vh; /* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
  background: #2a2a2a;
  border-radius: 18px;
  display: flex;
  flex-direction: column;
  padding: 10px;
  box-sizing: border-box;
  position: relative;
}

h2, h3 {
  margin: 4px 0;
  text-align: center;
}

input {
  padding: 7px;
  margin: 3px 0;
  border-radius: 8px;
  border: none;
  font-size: 13px;
}

button {
  padding: 7px;
  border: none;
  border-radius: 8px;
  background-color: #10a37f;
  color: white;
  font-size: 13px;
  cursor: pointer;
}

.back-button {
  position: absolute;
  top: 8px;
  left: 10px;
  font-size: 18px;
  cursor: pointer;
  opacity: 0.7;
}

#messages {
  flex: 1 1 auto;
  overflow-y: auto;
  margin: 6px 0;
  display: flex;
  flex-direction: column;
  scroll-behavior: smooth;
}

.message {
  max-width: 75%;
  padding: 7px 9px;
  border-radius: 14px;
  margin: 3px 0;
  font-size: 13px;
  animation: fadeIn 0.2s ease;
}

.mine {
  align-self: flex-end;
  background: white;
  color: black;
}

.other {
  align-self: flex-start;
  background: #10a37f;
  color: white;
}

.time {
  font-size: 10px;
  opacity: 0.6;
  margin-top: 2px;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}

#inputArea {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
}

#inputArea input {
  flex: 1;
  border-radius: 8px;
  padding: 7px;
}

#fileInputLabel {
  background-color: #10a37f;
  color: white;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  cursor: pointer;
  font-size: 18px;
}

#fileInput {
  display: none;
}

.chat-history {
  margin-top: 8px;
  background: #1f1f1f;
  border-radius: 10px;
  padding: 6px;
  max-height: 100px;
  overflow-y: auto;
  font-size: 12px;
}

.chat-item {
  padding: 4px;
  cursor: pointer;
  border-bottom: 1px solid #333;
}

.chat-item:last-child {
  border-bottom: none;
}

.chat-item:hover {
  background: #333;
}

.footer {
  position: absolute;
  bottom: 6px;
  width: 100%;
  text-align: center;
  font-size: 10px;
  opacity: 0.4;
}
</style>
</head>
<body>

<div id="login" class="container">
  <h2>CoChat</h2>
  <input id="usernameInput" placeholder="–í–∞—à–µ –∏–º—è">
  <input id="roomInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã">
  <input id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="enterChat()">–í–æ–π—Ç–∏</button>
  <div class="chat-history" id="historyBox"></div>
  <div class="footer">MEZENCEV&CO</div>
</div>

<div id="chat" class="container" style="display:none;">
  <div class="back-button" onclick="goBack()">‚Üê</div>
  <h3 id="roomTitle"></h3>
  <div id="messages"></div>
  <div id="inputArea">
    <label id="fileInputLabel" for="fileInput">‚ûï</label>
    <input type="file" id="fileInput" accept="image/*,video/*">
    <input id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
    <button onclick="sendMessage()">‚û§</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, remove, get, off }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA64EfxQkGhcCKnxAT_0k_3BTFt5wc6x-E",
  authDomain: "cochat-18c46.firebaseapp.com",
  databaseURL: "https://cochat-18c46-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cochat-18c46",
  storageBucket: "cochat-18c46.firebasestorage.app",
  messagingSenderId: "966021418904",
  appId: "1:966021418904:web:efdf644f1203088c4025ed"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

let currentRoom = "";
let username = "";
let currentListener = null;

const correctPassword = "1234";
const FIVE_DAYS = 5 * 24 * 60 * 60 * 1000;

/* ===== –ò–°–¢–û–†–ò–Ø (5 –ö–û–ú–ù–ê–¢) ===== */

function saveToHistory(room) {
  let history = JSON.parse(localStorage.getItem("chatHistory")) || [];
  history = history.filter(r => r !== room);
  history.unshift(room);
  if(history.length > 5) history.pop();
  localStorage.setItem("chatHistory", JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  const box = document.getElementById("historyBox");
  box.innerHTML = "";
  const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
  history.forEach(room => {
    const div = document.createElement("div");
    div.className = "chat-item";
    div.innerText = room;
    div.onclick = () => {
      document.getElementById("roomInput").value = room;
    };
    box.appendChild(div);
  });
}

renderHistory();

/* ===== –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î ===== */

window.goBack = function() {
  if(currentListener) {
    off(currentListener);
    currentListener = null;
  }
  document.getElementById("chat").style.display = "none";
  document.getElementById("login").style.display = "flex";
  document.getElementById("messages").innerHTML = "";
};

/* ===== –í–•–û–î ===== */

window.enterChat = async function() {
  const room = document.getElementById("roomInput").value.trim();
  const password = document.getElementById("passwordInput").value;
  username = document.getElementById("usernameInput").value.trim();

  if(password !== correctPassword) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
  if(room === "" || username === "") return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –∫–æ–º–Ω–∞—Ç—É");

  currentRoom = room;
  saveToHistory(room);

  const messagesRef = ref(database, "rooms/" + room);
  currentListener = messagesRef;

  const snapshot = await get(messagesRef);
  if(snapshot.exists()) {
    const data = snapshot.val();
    const keys = Object.keys(data);
    const lastMsg = data[keys[keys.length - 1]];
    if(Date.now() - lastMsg.timestamp > FIVE_DAYS) {
      await remove(messagesRef);
    }
  }

  document.getElementById("login").style.display = "none";
  document.getElementById("chat").style.display = "flex";
  document.getElementById("roomTitle").innerText = room;

  onChildAdded(messagesRef, (data) => {
    const msgData = data.val();
    displayMessage(msgData);
  });
};

/* ===== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô ===== */

function displayMessage(msgData) {
  const msg = document.createElement("div");
  msg.className = "message " +
    (msgData.user === username ? "mine" : "other");

  msg.innerHTML = `
    <div><strong>${msgData.user}</strong>: ${msgData.text}</div>
    <div class="time">${msgData.time}</div>
  `;

  const messagesBox = document.getElementById("messages");
  messagesBox.appendChild(msg);
  messagesBox.scrollTop = messagesBox.scrollHeight;
}

/* ===== –û–¢–ü–†–ê–í–ö–ê ===== */

window.sendMessage = function() {
  const input = document.getElementById("messageInput");
  if(input.value.trim() === "") return;

  const now = new Date();
  const timeString =
    now.getHours().toString().padStart(2,'0') + ":" +
    now.getMinutes().toString().padStart(2,'0');

  push(ref(database, "rooms/" + currentRoom), {
    user: username,
    text: input.value,
    time: timeString,
    timestamp: Date.now()
  });

  input.value = "";
};

/* ===== –§–ê–ô–õ–´ –õ–û–ö–ê–õ–¨–ù–û ===== */

document.getElementById("fileInput").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(event) {
    const dataURL = event.target.result;
    const msg = document.createElement("div");
    msg.className = "message mine";

    if(file.type.startsWith("image/")) {
      msg.innerHTML = `<img src="${dataURL}" style="max-width:200px; border-radius:10px;"><div class="time">üì∑</div>`;
    } else if(file.type.startsWith("video/")) {
      msg.innerHTML = `<video src="${dataURL}" style="max-width:200px;" controls></video><div class="time">üé•</div>`;
    }

    document.getElementById("messages").appendChild(msg);
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
  };
  reader.readAsDataURL(file);
  e.target.value = "";
});
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/sw.js")
      .then(() => console.log("Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω"))
      .catch(err => console.log("–û—à–∏–±–∫–∞ SW:", err));
  });
}
</script>

</body>
</html>
