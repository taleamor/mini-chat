<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>COCHAT</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#10a37f">

<style>
/* –ë–∞–∑–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ (–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ç–µ–º–∞) */
:root {
  --bg-color: #2a2a2a;
  --accent-color: #10a37f;
  --msg-mine: white;
  --msg-mine-text: black;
  --msg-other: #10a37f;
  --text-main: white;
}

/* –î–Ω–µ–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è (–Ø—Ä–∫–∞—è) */
body.theme-day {
  --bg-color: #f5f0e1;
  --accent-color: #d2b48c;
  --msg-mine: white;
  --msg-mine-text: black;
  --msg-other: #d2b48c;
  --text-main: #5d4037;
}

/* –ù–æ—á–Ω–∞—è –≤–µ—Ä—Å–∏—è (–î–µ—Ä–∑–∫–∞—è) */
body.theme-night {
  --bg-color: #000000;
  --accent-color: #ffffff;
  --msg-mine: #e0e0e0;
  --msg-mine-text: black;
  --msg-other: #333333;
  --text-main: white;
}

/* –≠–ª–µ–≥–∞–Ω—Ç–Ω–∞—è (–î–∂–µ–Ω—Ç–ª—å–º–µ–Ω—Å–∫–∞—è) */
body.theme-elegant {
  --bg-color: #1a237e;
  --accent-color: #c5a059;
  --msg-mine: white;
  --msg-mine-text: black;
  --msg-other: #c5a059;
  --text-main: white;
}

/* –õ–µ–¥–∏ –≤–µ—Ä—Å–∏—è (–ñ–µ–Ω—Å–∫–∞—è) */
body.theme-lady {
  --bg-color: #1b5e20;
  --accent-color: #880e4f;
  --msg-mine: #fff9c4;
  --msg-mine-text: black;
  --msg-other: #880e4f;
  --text-main: white;
}

body { margin:0; font-family: Arial, sans-serif; background-color: var(--bg-color); color: var(--text-main); display:flex; justify-content:center; align-items:flex-start; min-height:100vh; overflow-x:hidden; transition: 0.3s;}
html, body { height: 100%; overflow: hidden; position: fixed; width: 100%; }

.container { width:94%; max-width:460px; height:100vh; background: var(--bg-color); border-radius:18px; display:flex; flex-direction:column; padding:10px; box-sizing:border-box; position:relative; }
h2,h3 { margin:4px 0; text-align:center;}
input { padding:7px; margin:3px 0; border-radius:8px; border:none; font-size:13px; background: #333; color: white;}
button { padding:10px; border:none; border-radius:8px; background-color: var(--accent-color) !important; color:white; font-size:14px; cursor:pointer; margin-bottom: 8px; transition: 0.2s;}

#messages { flex:1 1 auto; overflow-y:auto; margin:6px 0; display:flex; flex-direction:column; scroll-behavior:smooth;}
.message { max-width:75%; padding:7px 9px; border-radius:14px; margin:3px 0; font-size:13px; position: relative; transition: transform 0.2s; }
.mine { align-self:flex-end; background: var(--msg-mine) !important; color: var(--msg-mine-text) !important; }
.other { align-self:flex-start; background: var(--msg-other) !important; color: white !important; }

.avatar-upload { width: 90px; height: 90px; border-radius: 12px; background: #333; margin: 10px auto; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid var(--accent-color); overflow: hidden; position: relative; }
.msg-avatar { width: 34px; height: 34px; border-radius: 6px; margin-right: 10px; object-fit: cover; }

#inputArea { display:flex; gap:4px; flex-shrink:0;}
#fileInputLabel, #callButton { background-color: var(--accent-color) !important; color:white; border-radius:8px; display:flex; align-items:center; justify-content:center; width:40px; height:40px; cursor:pointer; font-size:18px;}
#fileInput { display:none;}

.footer { width: 100%; text-align: center; font-size: 10px; opacity: 0.5; margin-top: 20px; display: flex; flex-direction: column; align-items: center; }

#scrollDownBtn { position:absolute; bottom:90px; right:20px; width:44px; height:44px; border-radius:12px; border:none; background: var(--accent-color); color:white; font-size:20px; display:flex; align-items:center; justify-content:center; cursor:pointer; opacity:0; pointer-events:none; transition: 0.25s; box-shadow:0 4px 15px rgba(0,0,0,0.3); z-index: 10; }
#scrollDownBtn.show { opacity:1; pointer-events:auto; }

#newMsgBadge { position:absolute; bottom:145px; left:50%; transform:translateX(-50%); background:#1f1f1f; color: var(--accent-color); padding:6px 14px; border-radius:12px; font-size:12px; opacity:0; pointer-events:none; transition: 0.25s; border:1px solid var(--accent-color); z-index: 10;}
#newMsgBadge.show { opacity:1; pointer-events:auto; }

.delete-ready { background: #ef4444 !important; color: white !important; }

/* –ê–Ω–∏–º–∞—Ü–∏—è —Ç–æ—á–µ–∫ */
.typing-dots::after { content:''; animation: dots 1.2s infinite; }
@keyframes dots { 0%{content:'';} 33%{content:'.';} 66%{content:'..';} 100%{content:'...';} }
</style>
</head>
<body>

<div id="login" class="container">
  <div style="display: flex; justify-content: flex-end; gap: 5px; margin-bottom: 10px;">
    <select id="themeSelector" onchange="changeTheme(this.value)" style="background: #333; color: white; border: 1px solid #10a37f; border-radius: 5px; font-size: 10px; padding: 5px;">
      <option value="default">–°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
      <option value="day">–î–Ω–µ–≤–Ω–∞—è</option>
      <option value="night">–ù–æ—á–Ω–∞—è</option>
      <option value="elegant">–≠–ª–µ–≥–∞–Ω—Ç</option>
      <option value="lady">–õ–µ–¥–∏</option>
    </select>
  </div>
  <h2>COCHAT</h2>
  <div class="avatar-upload" onclick="document.getElementById('avatarInput').click()">
    <img id="avatarPreview" src="https://ui-avatars.com/api/?name=User&background=333&color=fff&rounded=false" alt="Avatar">
    <input type="file" id="avatarInput" hidden accept="image/*">
  </div>
  <div style="text-align:center; font-size:11px; color:#10a37f; margin-bottom:12px; font-weight:bold;">–£–°–¢–ê–ù–û–í–ò–¢–¨ –§–û–¢–û</div>
  
  <input id="emailInput" placeholder="Email">
  <input id="authPasswordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  <button onclick="login()">–í–æ–π—Ç–∏</button>

  <hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">

  <input id="usernameInput" placeholder="–í–∞—à –Ω–∏–∫">
  <input id="roomInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã">
  <button onclick="enterChat()">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
  <div class="chat-history" id="historyBox"></div>

  <div class="footer">
    <div style="color: var(--accent-color); font-weight: bold; margin-bottom: 5px;">–∫–æ–º–Ω–∞—Ç–∞ —É–¥–∞–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ 5 –¥–Ω–µ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
    MEZENCEV&CO
  </div>
</div>

<div id="chat" class="container" style="display:none;">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div onclick="goBack()" style="cursor:pointer; font-size:20px;">‚Üê</div>
    <h3 id="roomTitle"></h3>
    <div style="width:20px;"></div>
  </div>
  <button onclick="logout()" style="background:#444 !important; font-size:10px; margin: 5px 0;">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
  
  <div id="messages"></div>
  <button id="scrollDownBtn">‚Üì</button>
  <div id="newMsgBadge">–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
  
  <div id="typingIndicator" style="height:20px; font-size:12px; opacity:0.7; margin-left:4px;"></div>
  
  <div id="inputArea">
    <label id="fileInputLabel" for="fileInput">‚ûï</label>
    <input type="file" id="fileInput" accept="image/*,video/*">
    <input id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
    <button id="callButton">üìû</button>
    <button onclick="sendMessage()">‚û§</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, remove, get, off, onValue, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyA64EfxQkGhcCKnxAT_0k_3BTFt5wc6x-E",
  authDomain: "cochat-18c46.firebaseapp.com",
  databaseURL: "https://cochat-18c46-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cochat-18c46",
  storageBucket: "cochat-18c46.firebasestorage.app",
  messagingSenderId: "966021418904",
  appId: "1:966021418904:web:efdf644f1203088c4025ed"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const auth = getAuth(app);

let currentRoom = "";
let username = "";
let userAvatar = null;
let unreadCount = 0;
const renderedMessages = new Set();

// –¢–ï–ú–´
window.changeTheme = function(theme) {
  document.body.classList.remove('theme-day', 'theme-night', 'theme-elegant', 'theme-lady');
  if (theme !== 'default') document.body.classList.add('theme-' + theme);
  localStorage.setItem('cochat-theme', theme);
};
const savedTheme = localStorage.getItem('cochat-theme') || 'default';
document.getElementById('themeSelector').value = savedTheme;
changeTheme(savedTheme);

// –ê–í–ê–¢–ê–†
document.getElementById('avatarInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (event) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = 100; canvas.height = 100;
      canvas.getContext('2d').drawImage(img, 0, 0, 100, 100);
      userAvatar = canvas.toDataURL('image/jpeg', 0.6);
      document.getElementById('avatarPreview').src = userAvatar;
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(file);
});

// –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø
window.register = async () => {
  const e = document.getElementById("emailInput").value;
  const p = document.getElementById("authPasswordInput").value;
  try { await createUserWithEmailAndPassword(auth, e, p); alert("–ì–æ—Ç–æ–≤–æ!"); } catch(ex) { alert(ex.message); }
};
window.login = async () => {
  const e = document.getElementById("emailInput").value;
  const p = document.getElementById("authPasswordInput").value;
  try { await signInWithEmailAndPassword(auth, e, p); alert("–í—ã –≤–æ—à–ª–∏!"); } catch(ex) { alert(ex.message); }
};
window.logout = () => signOut(auth).then(() => location.reload());

// –ß–ê–¢ –õ–û–ì–ò–ö–ê
window.enterChat = async () => {
  if(!auth.currentUser) return alert("–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç!");
  
  username = document.getElementById("usernameInput").value.trim();
  currentRoom = document.getElementById("roomInput").value.trim();
  if(!username || !currentRoom) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");

  document.getElementById("login").style.display = "none";
  document.getElementById("chat").style.display = "flex";
  document.getElementById("roomTitle").innerText = currentRoom;

  const mRef = ref(database, "rooms/" + currentRoom);
  onChildAdded(mRef, (data) => displayMessage(data.val()));
  
  // –ê–≤—Ç–æ-—Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –≤—Ö–æ–¥–µ
  setTimeout(() => {
    const box = document.getElementById("messages");
    box.scrollTop = box.scrollHeight;
    unreadCount = 0;
    document.getElementById("newMsgBadge").classList.remove("show");
  }, 500);
};

function displayMessage(msgData) {
  if(!msgData.user || renderedMessages.has(msgData.timestamp)) return;
  renderedMessages.add(msgData.timestamp);

  const box = document.getElementById("messages");
  const msg = document.createElement("div");
  msg.className = "message " + (msgData.user === username ? "mine" : "other");
  
  const avatar = msgData.avatar || `https://ui-avatars.com/api/?name=${msgData.user}&background=random`;
  
  msg.innerHTML = `
    <div style="display:flex; align-items:flex-start;">
      <img src="${avatar}" class="msg-avatar">
      <div>
        <div style="font-size:10px; font-weight:bold; opacity:0.8;">${msgData.user}</div>
        <div>${msgData.text || "üìé –§–∞–π–ª"}</div>
        <div style="font-size:9px; opacity:0.5; text-align:right;">${msgData.time || ""}</div>
      </div>
    </div>
  `;

  box.appendChild(msg);
  
  // –õ–æ–≥–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π "–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"
  const isBottom = box.scrollHeight - box.scrollTop - box.clientHeight < 100;
  if(!isBottom && msgData.user !== username) {
    unreadCount++;
    const badge = document.getElementById("newMsgBadge");
    badge.innerText = `–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (${unreadCount})`;
    badge.classList.add("show");
  } else {
    box.scrollTop = box.scrollHeight;
  }
}

window.sendMessage = () => {
  const input = document.getElementById("messageInput");
  if(!input.value.trim()) return;
  
  const now = new Date();
  const time = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
  
  push(ref(database, "rooms/" + currentRoom), {
    user: username,
    text: input.value,
    time: time,
    timestamp: Date.now(),
    avatar: userAvatar
  });
  input.value = "";
};

window.goBack = () => {
  document.getElementById("chat").style.display = "none";
  document.getElementById("login").style.display = "flex";
  renderedMessages.clear();
  document.getElementById("messages").innerHTML = "";
};

// –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä–æ–ª–ª–∞
document.getElementById("messages").onscroll = function() {
  const btn = document.getElementById("scrollDownBtn");
  if(this.scrollTop < this.scrollHeight - 500) btn.classList.add("show");
  else {
    btn.classList.remove("show");
    unreadCount = 0;
    document.getElementById("newMsgBadge").classList.remove("show");
  }
};
document.getElementById("scrollDownBtn").onclick = function() {
  const box = document.getElementById("messages");
  box.scrollTop = box.scrollHeight;
};

</script>
</body>
</html>
