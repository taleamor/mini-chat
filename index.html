<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CoChat</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background-color: #1e1e1e;
  color: white;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.container {
  width: 95%;
  max-width: 480px;
  height: 96vh;
  background: #2a2a2a;
  border-radius: 20px;
  display: flex;
  flex-direction: column;
  padding: 12px;
  box-sizing: border-box;
  position: relative;
}

h2, h3 {
  margin: 5px 0;
  text-align: center;
}

input {
  padding: 8px;
  margin: 4px 0;
  border-radius: 8px;
  border: none;
  font-size: 13px;
}

button {
  padding: 8px;
  border: none;
  border-radius: 8px;
  background-color: #10a37f;
  color: white;
  font-size: 13px;
  cursor: pointer;
}

.back-button {
  position: absolute;
  top: 10px;
  left: 12px;
  font-size: 18px;
  cursor: pointer;
  opacity: 0.7;
}

#messages {
  flex: 1;
  overflow-y: auto;
  margin: 8px 0;
  display: flex;
  flex-direction: column;
}

.message {
  max-width: 75%;
  padding: 8px 10px;
  border-radius: 15px;
  margin: 4px 0;
  font-size: 13px;
  animation: fadeIn 0.2s ease;
}

.mine {
  align-self: flex-end;
  background: white;
  color: black;
}

.other {
  align-self: flex-start;
  background: #10a37f;
  color: white;
}

.time {
  font-size: 10px;
  opacity: 0.6;
  margin-top: 3px;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

#inputArea {
  display: flex;
  gap: 5px;
}

#inputArea input {
  flex: 1;
}

#typingStatus {
  font-size: 11px;
  opacity: 0.7;
  min-height: 14px;
}

.chat-history {
  margin-top: 10px;
  background: #1f1f1f;
  border-radius: 10px;
  padding: 6px;
  max-height: 120px;
  overflow-y: auto;
  font-size: 12px;
}

.chat-item {
  padding: 4px;
  cursor: pointer;
  border-bottom: 1px solid #333;
}

.chat-item:last-child {
  border-bottom: none;
}

.chat-item:hover {
  background: #333;
}

.footer {
  position: absolute;
  bottom: 8px;
  width: 100%;
  text-align: center;
  font-size: 11px;
  opacity: 0.4;
}
</style>
</head>
<body>

<div id="login" class="container">
  <h2>CoChat</h2>
  <input id="usernameInput" placeholder="Ваше имя">
  <input id="roomInput" placeholder="Название комнаты">
  <input id="passwordInput" placeholder="Пароль">
  <button onclick="enterChat()">Войти</button>
  <div class="chat-history" id="historyBox"></div>
  <div class="footer">MEZENCEV&CO</div>
</div>

<div id="chat" class="container" style="display:none;">
  <div class="back-button" onclick="goBack()">←</div>
  <h3 id="roomTitle"></h3>
  <div id="messages"></div>
  <div id="typingStatus"></div>
  <div id="inputArea">
    <input id="messageInput" placeholder="Сообщение...">
    <button onclick="sendMessage()">➤</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, onValue, remove, get }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA64EfxQkGhcCKnxAT_0k_3BTFt5wc6x-E",
  authDomain: "cochat-18c46.firebaseapp.com",
  databaseURL: "https://cochat-18c46-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cochat-18c46",
  storageBucket: "cochat-18c46.firebasestorage.app",
  messagingSenderId: "966021418904",
  appId: "1:966021418904:web:efdf644f1203088c4025ed"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

let currentRoom = "";
let username = "";
const correctPassword = "1234";
const FIVE_DAYS = 5 * 24 * 60 * 60 * 1000;

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playTone(freq) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.value = freq;
  osc.type = "sine";
  gain.gain.value = 0.05;
  osc.start();
  setTimeout(() => osc.stop(), 100);
}

window.goBack = function() {
  document.getElementById("chat").style.display = "none";
  document.getElementById("login").style.display = "flex";
  document.getElementById("messages").innerHTML = "";
};

window.enterChat = async function() {
  const room = document.getElementById("roomInput").value.trim();
  const password = document.getElementById("passwordInput").value;
  username = document.getElementById("usernameInput").value.trim();

  if(password !== correctPassword) return alert("Неверный пароль");
  if(room === "" || username === "") return alert("Введите имя и комнату");

  currentRoom = room;

  const messagesRef = ref(database, "rooms/" + room);
  const snapshot = await get(messagesRef);

  if(snapshot.exists()) {
    const data = snapshot.val();
    const keys = Object.keys(data);
    const lastMsg = data[keys[keys.length - 1]];
    if(Date.now() - lastMsg.timestamp > FIVE_DAYS) {
      await remove(messagesRef);
    }
  }

  document.getElementById("login").style.display = "none";
  document.getElementById("chat").style.display = "flex";
  document.getElementById("roomTitle").innerText = room;

  onChildAdded(messagesRef, (data) => {
    const msgData = data.val();
    displayMessage(msgData);
  });
};

function displayMessage(msgData) {
  const msg = document.createElement("div");
  msg.className = "message " +
    (msgData.user === username ? "mine" : "other");

  msg.innerHTML = `
    <div><strong>${msgData.user}</strong>: ${msgData.text}</div>
    <div class="time">${msgData.time}</div>
  `;

  document.getElementById("messages").appendChild(msg);
  document.getElementById("messages").scrollTop =
    document.getElementById("messages").scrollHeight;

  if(msgData.user === username) {
    playTone(600);
  } else {
    playTone(400);
  }
}

window.sendMessage = function() {
  const input = document.getElementById("messageInput");
  if(input.value.trim() === "") return;

  const now = new Date();
  const timeString =
    now.getHours().toString().padStart(2,'0') + ":" +
    now.getMinutes().toString().padStart(2,'0');

  push(ref(database, "rooms/" + currentRoom), {
    user: username,
    text: input.value,
    time: timeString,
    timestamp: Date.now()
  });

  input.value = "";
};
</script>

</body>
</html>
