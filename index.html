<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CoChat</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#10a37f">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background-color: #1e1e1e;
  color: white;
  display: flex;
  justify-content: center;
  align-items: flex-start; /* чтобы контейнер начинался сверху */
  min-height: 100vh;
  overflow-x: hidden; /* убираем горизонтальный скролл */
}

.container {
  width: 94%;
  max-width: 460px;
  min-height: 90vh; /* растягиваем по высоте экрана */
  background: #2a2a2a;
  border-radius: 18px;
  display: flex;
  flex-direction: column;
  padding: 10px;
  box-sizing: border-box;
  position: relative;
}

h2, h3 {
  margin: 4px 0;
  text-align: center;
}

input {
  padding: 7px;
  margin: 3px 0;
  border-radius: 8px;
  border: none;
  font-size: 13px;
}

button {
  padding: 7px;
  border: none;
  border-radius: 8px;
  background-color: #10a37f;
  color: white;
  font-size: 13px;
  cursor: pointer;
}

.back-button {
  position: absolute;
  top: 8px;
  left: 10px;
  font-size: 18px;
  cursor: pointer;
  opacity: 0.7;
}

#messages {
  flex: 1 1 auto; /* растягиваем на доступное место */
  overflow-y: auto;
  margin: 6px 0;
  display: flex;
  flex-direction: column;
  scroll-behavior: smooth; /* плавная прокрутка */
}

.message {
  max-width: 75%;
  padding: 7px 9px;
  border-radius: 14px;
  margin: 3px 0;
  font-size: 13px;
  animation: fadeIn 0.2s ease;
}

.mine {
  align-self: flex-end;
  background: white;
  color: black;
}

.other {
  align-self: flex-start;
  background: #10a37f;
  color: white;
}

.time {
  font-size: 10px;
  opacity: 0.6;
  margin-top: 2px;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}

#inputArea {
  display: flex;
  gap: 4px;
  flex-shrink: 0; /* остаётся всегда внизу */
}

#inputArea input {
  flex: 1;
}

.chat-history {
  margin-top: 8px;
  background: #1f1f1f;
  border-radius: 10px;
  padding: 6px;
  max-height: 100px;
  overflow-y: auto;
  font-size: 12px;
}

.chat-item {
  padding: 4px;
  cursor: pointer;
  border-bottom: 1px solid #333;
}

.chat-item:last-child {
  border-bottom: none;
}

.chat-item:hover {
  background: #333;
}

.footer {
  position: absolute;
  bottom: 6px;
  width: 100%;
  text-align: center;
  font-size: 10px;
  opacity: 0.4;
}
</style>
</head>
<body>

<div id="login" class="container">
  <h2>CoChat</h2>
  <input id="usernameInput" placeholder="Ваше имя">
  <input id="roomInput" placeholder="Название комнаты">
  <input id="passwordInput" placeholder="Пароль">
  <button onclick="enterChat()">Войти</button>
  <div class="chat-history" id="historyBox"></div>
  <div class="footer">MEZENCEV&CO</div>
</div>

<div id="chat" class="container" style="display:none;">
  <div class="back-button" onclick="goBack()">←</div>
  <h3 id="roomTitle"></h3>
  <div id="messages"></div>
  <div id="inputArea">
    <input id="messageInput" placeholder="Сообщение...">
    <button onclick="sendMessage()">➤</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, remove, get, off }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA64EfxQkGhcCKnxAT_0k_3BTFt5wc6x-E",
  authDomain: "cochat-18c46.firebaseapp.com",
  databaseURL: "https://cochat-18c46-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cochat-18c46",
  storageBucket: "cochat-18c46.firebasestorage.app",
  messagingSenderId: "966021418904",
  appId: "1:966021418904:web:efdf644f1203088c4025ed"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

let currentRoom = "";
let username = "";
let currentListener = null;

const correctPassword = "1234";
const FIVE_DAYS = 5 * 24 * 60 * 60 * 1000;

/* ===== ИСТОРИЯ (5 КОМНАТ) ===== */

function saveToHistory(room) {
  let history = JSON.parse(localStorage.getItem("chatHistory")) || [];
  history = history.filter(r => r !== room);
  history.unshift(room);
  if(history.length > 5) history.pop();
  localStorage.setItem("chatHistory", JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  const box = document.getElementById("historyBox");
  box.innerHTML = "";
  const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
  history.forEach(room => {
    const div = document.createElement("div");
    div.className = "chat-item";
    div.innerText = room;
    div.onclick = () => {
      document.getElementById("roomInput").value = room;
    };
    box.appendChild(div);
  });
}

renderHistory();

/* ===== КНОПКА НАЗАД ===== */

window.goBack = function() {
  if(currentListener) {
    off(currentListener);
    currentListener = null;
  }
  document.getElementById("chat").style.display = "none";
  document.getElementById("login").style.display = "flex";
  document.getElementById("messages").innerHTML = "";
};

/* ===== ВХОД ===== */

window.enterChat = async function() {
  const room = document.getElementById("roomInput").value.trim();
  const password = document.getElementById("passwordInput").value;
  username = document.getElementById("usernameInput").value.trim();

  if(password !== correctPassword) return alert("Неверный пароль");
  if(room === "" || username === "") return alert("Введите имя и комнату");

  currentRoom = room;
  saveToHistory(room);

  const messagesRef = ref(database, "rooms/" + room);
  currentListener = messagesRef;

  const snapshot = await get(messagesRef);
  if(snapshot.exists()) {
    const data = snapshot.val();
    const keys = Object.keys(data);
    const lastMsg = data[keys[keys.length - 1]];
    if(Date.now() - lastMsg.timestamp > FIVE_DAYS) {
      await remove(messagesRef);
    }
  }

  document.getElementById("login").style.display = "none";
  document.getElementById("chat").style.display = "flex";
  document.getElementById("roomTitle").innerText = room;

  onChildAdded(messagesRef, (data) => {
    const msgData = data.val();
    displayMessage(msgData);
  });
};

/* ===== ОТОБРАЖЕНИЕ СООБЩЕНИЙ ===== */

function displayMessage(msgData) {
  const msg = document.createElement("div");
  msg.className = "message " +
    (msgData.user === username ? "mine" : "other");

  msg.innerHTML = `
    <div><strong>${msgData.user}</strong>: ${msgData.text}</div>
    <div class="time">${msgData.time}</div>
  `;

  const messagesBox = document.getElementById("messages");
  messagesBox.appendChild(msg);
  messagesBox.scrollTop = messagesBox.scrollHeight;
}

/* ===== ОТПРАВКА ===== */

window.sendMessage = function() {
  const input = document.getElementById("messageInput");
  if(input.value.trim() === "") return;

  const now = new Date();
  const timeString =
    now.getHours().toString().padStart(2,'0') + ":" +
    now.getMinutes().toString().padStart(2,'0');

  push(ref(database, "rooms/" + currentRoom), {
    user: username,
    text: input.value,
    time: timeString,
    timestamp: Date.now()
  });

  input.value = "";
};
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/sw.js")
      .then(() => console.log("Service Worker зарегистрирован"))
      .catch(err => console.log("Ошибка SW:", err));
  });
}
</script>

</body>
</html>
