<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>COCHAT</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#10a37f">

<style>
/* === –°—Ç–∏–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏–º –∫–Ω–æ–ø–∫—É –∑–≤–æ–Ω–∫–∞ —á—É—Ç—å –±–æ–ª—å—à–µ === */
body { margin:0; font-family: Arial, sans-serif; background-color: #2a2a2a; color: white; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; overflow-x:hidden;}
html, body {
  height: 100%;
  overflow: hidden; /* –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π —Å–∫—Ä–æ–ª–ª –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
  position: fixed;
  width: 100%;
}
.container { width:94%; max-width:460px; height:100vh; background:#2a2a2a; border-radius:18px; display:flex; flex-direction:column; padding:10px; box-sizing:border-box; position:relative;animation: fadeChat 0.3s ease;}
h2,h3 { margin:4px 0; text-align:center;}
input { padding:7px; margin:3px 0; border-radius:8px; border:none; font-size:13px;}
button { padding:10px; border:none; border-radius:8px; background-color:#10a37f; color:white; font-size:14px; cursor:pointer; margin-bottom: 8px;}
.back-button { position:absolute; top:8px; left:10px; font-size:18px; cursor:pointer; opacity:0.7;}
#messages { flex:1 1 auto; overflow-y:auto; margin:6px 0; display:flex; flex-direction:column; scroll-behavior:smooth;}
.message { max-width:75%; padding:7px 9px; border-radius:14px; margin:3px 0; font-size:13px; animation:fadeIn 0.2s ease;}
.mine { align-self:flex-end; background:white; color:black;}
.other { align-self:flex-start; background:#10a37f; color:white;}
.time { font-size:10px; opacity:0.6; margin-top:2px;}
@keyframes fadeIn {
  from { 
    opacity:0; 
    transform:translateY(8px) scale(0.98);
  }
  to {
    opacity:1;
    transform:translateY(0) scale(1);
  }
}
fadeChat{
  from { opacity:0; transform:scale(0.98); }
  to { opacity:1; transform:scale(1); }
}
#inputArea { display:flex; gap:4px; flex-shrink:0;}
#inputArea input { flex:1; border-radius:8px; padding:7px;}
#fileInputLabel { background-color:#10a37f; color:white; border-radius:8px; display:flex; align-items:center; justify-content:center; width:40px; cursor:pointer; font-size:18px;}
#callButton { background-color:#28a745; width:40px; font-size:18px; display:flex; justify-content:center; align-items:center;} /* –∫–Ω–æ–ø–∫–∞ –∑–≤–æ–Ω–∫–∞ */
#fileInput { display:none;}
.chat-history { margin-top:8px; background:#1f1f1f; border-radius:10px; padding:6px; max-height:100px; overflow-y:auto; font-size:12px;}
.chat-item { padding:4px; cursor:pointer; border-bottom:1px solid #333;}
.chat-item:last-child { border-bottom:none;}
.chat-item:hover { background:#333;}
.footer {
  width: 100%;
  text-align: center;
  font-size: 10px;
  opacity: 0.5;
  margin-top: 20px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∫–Ω–æ–ø–æ–∫ –≤—Ö–æ–¥–∞ –¥–æ –∏–Ω—Ñ–æ-–±–ª–æ–∫–∞ */
  display: flex;
  flex-direction: column;
  align-items: center;
}
#messages::-webkit-scrollbar {
  width:6px;
}
#messages::-webkit-scrollbar-thumb {
  background: #333;
  border-radius:10px;
}
*{
  transition: background 0.2s ease, color 0.2s ease;
}
/* === –≠—Ñ—Ñ–µ–∫—Ç –≥–ª—É–±–∏–Ω—ã –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ === */
button,
#fileInputLabel,
#callButton {
  transition: all 0.15s ease;
}

button:active,
#fileInputLabel:active,
#callButton:active {
  transform: scale(0.92);
  box-shadow: inset 0 4px 10px #333;
}
.message:active {
  transform: scale(0.97);
}
/* === –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ glow === */
.message.new-glow {
  animation: messageGlow 1.2s ease;
}

@keyframes messageGlow {
  0% {
    box-shadow: 0 0 0 #333;
  }
  30% {
    box-shadow: 0 0 25px #10a37f;
  }
  100% {
    box-shadow: 0 0 0 #333;
  }
}
/* === Swipe delete === */
.message {
  position: relative;
  transition: transform 0.2s ease, opacity 0.2s ease;
}

.message.swiping {
  transition: none;
}

.message.delete-ready {
  background: linear-gradient(145deg,#ef4444,#991b1b) !important;
  color: white !important;
}
#callPanel {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.8);
  padding: 10px 20px;
  border-radius: 25px;
  display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
  gap: 15px;
  z-index: 10000;
  border: 1px solid #10a37f;
  align-items: center;
}
.call-btn-ui {
  padding: 8px 15px !important;
  font-size: 12px !important;
}
.btn-hangup { background-color: #ef4444 !important; }
.avatar-upload {
  width: 90px;
  height: 90px;
  border-radius: 12px; /* –ö–≤–∞–¥—Ä–∞—Ç —Å–æ —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º */
  background: #333;
  margin: 10px auto;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border: 2px solid #10a37f;
  overflow: hidden;
  position: relative;
}
.avatar-upload img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.msg-avatar {
  width: 34px;
  height: 34px;
  border-radius: 6px; /* –ö–≤–∞–¥—Ä–∞—Ç–Ω–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞ –≤ —á–∞—Ç–µ */
  margin-right: 10px;
  object-fit: cover;
}
/* –§–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–∫—Å —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∏ —Ñ—É—Ç–µ—Ä–∞ */
#login .footer {
  position: relative; /* –£–±–∏—Ä–∞–µ–º absolute, —á—Ç–æ–±—ã –æ–Ω —à–µ–ª –ø–æ—Å–ª–µ –∫–Ω–æ–ø–æ–∫ */
  margin-top: 30px;
  width: 100%;
  left: 0;
  transform: none;
}

#login .footer div {
  width: 100%;
  text-align: center;
}

#login .brandPalm svg {
  display: block;
  margin: 0 auto; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç SVG –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ */
}
/* ===== –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø ===== */
@media (max-width: 600px) {
  input {
    font-size:16px;
    padding:12px;
  }

  button {
    font-size:16px;
    padding:14px;
  }

  .message {
    font-size:15px;
    padding:10px 14px;
  }

  #fileInputLabel,
  #callButton {
    width:52px;
    height:52px;
    font-size:22px;
  }
  #typingIndicator strong{
  color:#10a37f;
  font-weight:600;
}

.typing-dots::after{
  content:'';
  animation: dots 1.2s infinite;
}

@keyframes dots{
  0%{content:'';}
  33%{content:'.';}
  66%{content:'..';}
  100%{content:'...';}
}

.brandPalm {
  display: flex;
  justify-content: center;
  width: 100%;
  margin-bottom: 5px;
}

.delete-warning {
  text-align: center;
  font-size: 11px;
  color: #10a37f;
  opacity: 0.8;
  font-weight: 500;
  margin: 0 auto 10px auto; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç –±–ª–æ–∫ –∏ –¥–∞–µ—Ç –æ—Ç—Å—Ç—É–ø –¥–æ –ø–∞–ª—å–º—ã */
  width: 100%;
}

.delete-warning div {
  text-transform: lowercase; /* –≤—Å–µ –±—É–∫–≤—ã –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ —Ä–æ—Å—Ç–∞ */
}
#callScreen button {
  padding:10px;
  border:none;
  border-radius:8px;
  background-color:#10a37f;
  color:white;
  font-size:14px;
  cursor:pointer;
  flex:1;
}
#callScreen h3 {
  text-align:center;
  margin:4px 0;
}
#callScreen audio {
  width:100%;
  margin-top:6px;
  border-radius:8px;
}
#callControls {
  display:flex;
  position:sticky;
  top:6px;
  z-index:100;
}

#callControls button {
  padding:10px;
  border:none;
  border-radius:8px;
  background-color:#10a37f;
  color:white;
  font-size:14px;
  cursor:pointer;
}

}
/* ===== –ö–Ω–æ–ø–∫–∞ –≤–Ω–∏–∑ ===== */
#scrollDownBtn{
  position:absolute;
  bottom:90px;
  right:20px;
  width:44px;
  height:44px;
  border-radius:12px;
  border:none;
  background:#10a37f;
  color:white;
  font-size:20px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  opacity:0;
  pointer-events:none;
  transform:translateY(10px);
  transition: all 0.25s ease;
  box-shadow:0 4px 15px rgba(0,0,0,0.3);
}

/* –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
#scrollDownBtn.show{
  opacity:1;
  pointer-events:auto;
  transform:translateY(0);
}

#scrollDownBtn:active{
  transform:scale(0.9);
}
/* ===== –ë–µ–π–¥–∂ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ===== */
#newMsgBadge{
  position:absolute;
  bottom:145px;
  left:50%;
  transform:translateX(-50%) translateY(10px);
  background:#1f1f1f;
  color:#10a37f;
  padding:6px 14px;
  border-radius:12px;
  font-size:12px;
  opacity:0;
  pointer-events:none;
  transition: all 0.25s ease;
  box-shadow:0 4px 12px rgba(0,0,0,0.4);
  border:1px solid #10a37f;
}

#newMsgBadge.show{
  opacity:1;
  pointer-events:auto;
  transform:translateX(-50%) translateY(0);
}
#inputArea button {
  margin-bottom: 0; /* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —Å—Ç—Ä–æ–∫–µ –≤–≤–æ–¥–∞ */
  height: 40px;     /* –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã –≤—Å—ë –±—ã–ª–æ –≤ –æ–¥–Ω—É –ª–∏–Ω–∏—é */
}

@media (max-width: 600px) {
  #inputArea button {
    height: 52px;   /* –î–ª—è –º–æ–±–∏–ª–æ–∫ –≤—ã—Å–æ—Ç–∞ —á—É—Ç—å –±–æ–ª—å—à–µ, –∫–∞–∫ —É –∞–≤–∞—Ç–∞—Ä–æ–∫ */
  }
}

</style>
</head>
<body>

<div id="login" class="container">
  <h2>COCHAT</h2>
  <div class="avatar-upload" onclick="document.getElementById('avatarInput').click()">
  <img id="avatarPreview" src="https://ui-avatars.com/api/?name=User&background=333&color=fff&rounded=false" alt="Avatar">
  <input type="file" id="avatarInput" hidden accept="image/*">
</div>
<div style="text-align:center; font-size:11px; color:#10a37f; margin-bottom:12px; font-weight:bold;">–£–°–¢–ê–ù–û–í–ò–¢–¨ –§–û–¢–û</div>
  <input id="emailInput" placeholder="Email">
<input id="authPasswordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
<button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
<button onclick="login()">–í–æ–π—Ç–∏</button>

<hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">

<input id="usernameInput" placeholder="–í–∞—à –Ω–∏–∫">
<input id="roomInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã">
<button onclick="enterChat()">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
  <div class="chat-history" id="historyBox"></div>
  <div class="footer">
  <div class="delete-warning">
    <div>–∫–æ–º–Ω–∞—Ç–∞ —É–¥–∞–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑</div>
    <div>5 –¥–Ω–µ–π –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
  </div>
  <div class="brandPalm">
    <svg viewBox="0 0 100 100" width="42" height="42">
      <path d="M50 60 L50 90" stroke="white" stroke-width="4" stroke-linecap="round"/>
      <path d="M50 60 
               C30 45, 20 40, 10 35
               M50 60 
               C70 45, 80 40, 90 35
               M50 60 
               C25 55, 15 60, 5 65
               M50 60 
               C75 55, 85 60, 95 65
               M50 60 
               C35 40, 30 25, 25 15
               M50 60 
               C65 40, 70 25, 75 15"
            stroke="white"
            stroke-width="4"
            stroke-linecap="round"
            fill="none"/>
    </svg>
  </div>
  MEZENCEV&CO
</div>

</div>

<div id="chat" class="container" style="display:none;">
  <div class="back-button" onclick="goBack()">‚Üê</div>
  <h3 id="roomTitle"></h3>
  <button onclick="logout()" style="background:#444;margin-bottom:5px;">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
  <div id="messages"></div>
  <button id="scrollDownBtn">‚Üì</button>
  <div id="newMsgBadge">–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
  <div id="typingIndicator" style="height:20px;font-size:12px;opacity:0.7;margin-left:4px;"></div>
  <div id="inputArea">
    <label id="fileInputLabel" for="fileInput">‚ûï</label>
    <input type="file" id="fileInput" accept="image/*,video/*">
    <input id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
    <button id="callButton">üìû</button>
    <button onclick="sendMessage()">‚û§</button>
  </div>
</div>
<div id="callPanel">
  <span id="callStatus" style="font-size:12px; margin-right:5px;">–ù–∞ —Å–≤—è–∑–∏</span>
  <button id="muteBtn" class="call-btn-ui">–ú—É—Ç</button>
  <button id="hangupBtn" class="call-btn-ui btn-hangup">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, remove, get, off, onValue, set } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
import { 
  getAuth, 
  createUserWithEmailAndPassword, 
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
let userAvatar = null;

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏
document.getElementById('avatarInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(event) {
    const img = new Image();
    img.onload = function() {
      // –°–∂–∏–º–∞–µ–º –¥–æ 100x100 –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
      const canvas = document.createElement('canvas');
      canvas.width = 100;
      canvas.height = 100;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, 100, 100);
      
      userAvatar = canvas.toDataURL('image/jpeg', 0.6); // –ö–∞—á–µ—Å—Ç–≤–æ 60%
      document.getElementById('avatarPreview').src = userAvatar;
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(file);
});
  // ===== ENGINE v2: –∞–Ω—Ç–∏-—Å–ø–∞–º =====
let lastSendTime = 0;

// ===== ENGINE v2: –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π =====
const renderedMessages = new Set();

const firebaseConfig = {
  apiKey: "AIzaSyA64EfxQkGhcCKnxAT_0k_3BTFt5wc6x-E",
  authDomain: "cochat-18c46.firebaseapp.com",
  databaseURL: "https://cochat-18c46-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cochat-18c46",
  storageBucket: "cochat-18c46.firebasestorage.app",
  messagingSenderId: "966021418904",
  appId: "1:966021418904:web:efdf644f1203088c4025ed"
};

const ringtone = new Audio('https://assets.mixkit.co/active_storage/sfx/1358/1358-preview.mp3'); // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–≤—É–∫ –∑–≤–æ–Ω–∫–∞
ringtone.loop = true; // –ß—Ç–æ–±—ã –º–µ–ª–æ–¥–∏—è –ø–æ–≤—Ç–æ—Ä—è–ª–∞—Å—å, –ø–æ–∫–∞ –Ω–µ –æ—Ç–≤–µ—Ç—è—Ç
/* ===== v3: –û–Ω–ª–∞–π–Ω/–æ—Ñ–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å ===== */
let onlineRef = null;

function setOnlineStatus() {
  if(!currentRoom || !username) return;
  onlineRef = ref(database, `rooms/${currentRoom}/online/${username}`);
  set(onlineRef, true);

  // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
  window.addEventListener("beforeunload", () => set(onlineRef, null));
}


// –°–ª—É—à–∞–µ–º –æ–Ω–ª–∞–π–Ω –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function subscribeOnlineUsers() {
  if(!currentRoom) return;
  const onlineListRef = ref(database, `rooms/${currentRoom}/online`);
  onValue(onlineListRef, snap => {
    const users = snap.val() ? Object.keys(snap.val()) : [];
    console.log("–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å:", users.filter(u => u !== username).join(", "));
  });
}

/* ===== v3: Lazy –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 50 —Å–æ–æ–±—â–µ–Ω–∏–π ===== */
async function loadLastMessages(roomRef) {
  const snapshot = await get(roomRef);
  if(snapshot.exists()){
    const data = snapshot.val();
    const keys = Object.keys(data).sort((a,b) => data[a].timestamp - data[b].timestamp);
    keys.slice(-50).forEach(key => displayMessage(data[key]));
  }
}

/* ===== v3: WebRTC –±–µ–∑–æ–ø–∞—Å–Ω—ã–π ICE ===== */
function setupIceCandidates(pc, peerName) {
  // –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
  pc.onicecandidate = (event) => {
    if(event.candidate){
      push(ref(database, `rooms/${currentRoom}/ice/${username}_to_${peerName}`), event.candidate.toJSON());
    }
  };

  // –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
  const iceRef = ref(database, `rooms/${currentRoom}/ice/${peerName}_to_${username}`);
  onChildAdded(iceRef, (snap) => {
    const candidate = snap.val();
    if(candidate && currentPC){
      currentPC.addIceCandidate(new RTCIceCandidate(candidate));
    }
  });
}

/* ===== v3: –ê–≤—Ç–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞ ===== */
function setupConnectionState(pc, peerName) {
  pc.onconnectionstatechange = () => {
    if(pc.connectionState === "disconnected" || pc.connectionState === "failed"){
      console.log("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–ø–∞–ª–æ, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å...");
      setTimeout(() => {
        if(!window.inCall) startCall(false, peerName);
      }, 2000);
    }
    if(pc.connectionState === "closed"){
      resetCall();
    }
  };
}

/* ===== v3: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–≤–æ–Ω–∫–µ (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ) ===== */
function subscribeIncomingCalls() {
  if(!currentRoom) return;
  const callRef = ref(database, `rooms/${currentRoom}/call`);
  onValue(callRef, (snap) => {
    const callData = snap.val();
    if(callData && callData.to===username && !window.inCall){
      ringtone.play().catch(e => console.log("–ù—É–∂–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Å–∞–π—Ç–æ–º –¥–ª—è –∑–≤—É–∫–∞")); 

if(confirm(`${callData.from} –∑–≤–æ–Ω–∏—Ç! –ü—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫?`)){
  ringtone.pause();
  ringtone.currentTime = 0;
  startCall(true, callData.from); 
} else {
  ringtone.pause();
  ringtone.currentTime = 0;
  set(ref(database, `rooms/${currentRoom}/call`), null); 
}
    }
  });
}

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const auth = getAuth(app);
onAuthStateChanged(auth, (user) => {
  if(user){
    console.log("–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:", user.email);
  } else {
    console.log("–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");
  }
});
if ("Notification" in window) {
  Notification.requestPermission().then(permission => {
    console.log("–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:", permission);
  });
}

let currentRoom = "";
let username = "";
window.register = async function(){
  const email = document.getElementById("emailInput").value;
  const password = document.getElementById("authPasswordInput").value;

  if(!email || !password) return alert("–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å");

  try{
    await createUserWithEmailAndPassword(auth, email, password);
    alert("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω");
  } catch(err){
    alert(err.message);
  }
};

window.login = async function(){
  const email = document.getElementById("emailInput").value;
  const password = document.getElementById("authPasswordInput").value;

  if(!email || !password) return alert("–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å");

  try{
    await signInWithEmailAndPassword(auth, email, password);
    alert("–í—ã –≤–æ—à–ª–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç");
  } catch(err){
    alert(err.message);
  }
};
let typingTimeout = null;
let typingRef = null;
let currentTypingUser = null;
let currentListener = null;
const FIVE_DAYS = 5 * 24 * 60 * 60 * 1000;

/* ===== –ó–í–£–ö–ò –°–û–û–ë–©–ï–ù–ò–ô ===== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSendSound(){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "sine";
  osc.frequency.setValueAtTime(600, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(900, audioCtx.currentTime + 0.08);

  gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.15, audioCtx.currentTime + 0.01);
  gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.15);

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start();
  osc.stop(audioCtx.currentTime + 0.15);
}

function playReceiveSound(){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "triangle";
  osc.frequency.setValueAtTime(500, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(700, audioCtx.currentTime + 0.1);

  gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.02);
  gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.2);

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start();
  osc.stop(audioCtx.currentTime + 0.2);
}

/* ===== –ò–°–¢–û–†–ò–Ø ===== */
function saveToHistory(room) { let history = JSON.parse(localStorage.getItem("chatHistory")) || []; history = history.filter(r => r !== room); history.unshift(room); if(history.length>5) history.pop(); localStorage.setItem("chatHistory", JSON.stringify(history)); renderHistory();}
function renderHistory() { const box = document.getElementById("historyBox"); box.innerHTML=""; const history=JSON.parse(localStorage.getItem("chatHistory"))||[]; history.forEach(room=>{const div=document.createElement("div"); div.className="chat-item"; div.innerText=room; div.onclick=()=>{document.getElementById("roomInput").value=room;}; box.appendChild(div);}); }
renderHistory();

/* ===== –ù–ê–ó–ê–î ===== */
window.goBack = function() {
  resetCall();

  if(currentListener) off(currentListener);
  if(typingRef) off(typingRef);
  if(onlineRef) set(onlineRef, null); // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω

  if(currentRoom && username){
    set(ref(database, "rooms/" + currentRoom + "/typing/" + username), false);
  }

  document.getElementById("chat").style.display = "none";
  document.getElementById("login").style.display = "flex";
  document.getElementById("messages").innerHTML = "";
  renderedMessages.clear();
};

window.logout = async function(){
  await signOut(auth);
  alert("–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞");
  location.reload();
};

/* ===== –í–•–û–î ===== */
window.enterChat = async function() {
  if(!auth.currentUser){
  return alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç");
  // –°–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã —Å–æ–æ–±—â–µ–Ω–∏—è —É—Å–ø–µ–ª–∏ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è
 // –°–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑ –∏ —á–∏—Å—Ç–∏–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –≤—Ö–æ–¥–µ
 setTimeout(() => {
    const messagesBox = document.getElementById("messages");
    const newMsgBadge = document.getElementById("newMsgBadge");
    
    messagesBox.scrollTop = messagesBox.scrollHeight;
    unreadCount = 0; 
    
    if(newMsgBadge) {
      newMsgBadge.classList.remove("show");
      newMsgBadge.innerText = "–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"; 
    }
  }, 300);
}
  
  // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –±—ã–ª–∏
  if(currentListener) off(currentListener);
  if(typingRef) off(typingRef);
  
  const room = document.getElementById("roomInput").value.trim();
  username = document.getElementById("usernameInput").value.trim();

  if(room === "" || username === "") return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –∫–æ–º–Ω–∞—Ç—É");

  currentRoom = room; 
  saveToHistory(room);
  setOnlineStatus();  // v3
subscribeOnlineUsers(); // v3
subscribeIncomingCalls(); // v3
  const messagesRef = ref(database,"rooms/"+room);
  currentListener = messagesRef;
  const snapshot = await get(messagesRef);
  if(snapshot.exists()){ const data = snapshot.val(); const keys=Object.keys(data); const lastMsg=data[keys[keys.length-1]]; if(Date.now()-lastMsg.timestamp>FIVE_DAYS){ await remove(messagesRef); } }
  document.getElementById("login").style.display="none"; document.getElementById("chat").style.display="flex";
  document.getElementById("roomTitle").innerText=room;
  onChildAdded(messagesRef,(data)=>{ const msgData = data.val(); displayMessage(msgData); });

  currentTypingUser = null;
  // ===== –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø–µ—á–∞—Ç–∞–µ—Ç =====
typingRef = ref(database,"rooms/"+room+"/typing");

onValue(typingRef, (snap) => {
    const data = snap.val() || {};
    const indicator = document.getElementById("typingIndicator");
    const users = Object.keys(data).filter(u => data[u] === true && u !== username);

    if(users.length > 0){
        // –µ—Å–ª–∏ currentTypingUser –Ω–µ –≤ —Å–ø–∏—Å–∫–µ, –±–µ—Ä—ë–º –ø–µ—Ä–≤–æ–≥–æ –Ω–æ–≤–æ–≥–æ
        if(!currentTypingUser || !users.includes(currentTypingUser)){
            currentTypingUser = users[0];
        }
        indicator.innerHTML = `<strong>${currentTypingUser}</strong> –ø–∏—à–µ—Ç<span class="typing-dots"></span>`;
    } else {
        // –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ –∏—Å—á–µ–∑–∞–ª –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
        setTimeout(() => {
            // –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –Ω–∏–∫ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–ø–∞–ª
            if(typingRef){
                const stillTyping = Object.keys(data).filter(u => data[u] === true && u !== username);
                if(stillTyping.length === 0){
                    indicator.innerHTML = "";
                    currentTypingUser = null;
                }
            }
        }, 800); // 0.8 —Å–µ–∫—É–Ω–¥—ã –∑–∞–¥–µ—Ä–∂–∫–∏
    }
});

  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∑–≤–æ–Ω–∫–∏
  callRef = ref(database, "rooms/"+room+"/call");
  onValue(callRef,(snap)=>{
    const callData = snap.val();
    if(callData && callData.to===username && !window.inCall){
      if(confirm(`${callData.from} –∑–≤–æ–Ω–∏—Ç! –ü—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫?`)){
        startCall(true,callData.from); // –ø—Ä–∏–Ω—è–ª –∑–≤–æ–Ω–æ–∫
      } else {
        set(callRef,null); // –æ—Ç–∫–ª–æ–Ω–∏—Ç—å
      }
    }
  });
};

/* ===== –ü–û–ö–ê–ó –°–û–û–ë–©–ï–ù–ò–ô ===== */
function setupTypingListener() {
    onValue(typingRef, (snap) => {
        const data = snap.val() || {};
        const indicator = document.getElementById("typingIndicator");
        const users = Object.keys(data).filter(u => data[u] === true && u !== username);

        if(users.length > 0){
            indicator.innerHTML = `<strong>${users[0]}</strong> –ø–∏—à–µ—Ç<span class="typing-dots"></span>`;
        } else {
            indicator.innerHTML = "";
        }
    });
}
function displayMessage(msgData){
if(msgData.timestamp && renderedMessages.has(msgData.timestamp)) return;
if(msgData.timestamp) renderedMessages.add(msgData.timestamp);

  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (call, ice –∏ —Ç.–¥.)
  if(!msgData.user || (!msgData.text && msgData.type!=="file")){
    return;
  }

  const msg=document.createElement("div");
  msg.dataset.timestamp = msgData.timestamp;
  msg.className="message "+(msgData.user===username?"mine":"other");

  if(msgData.type==="file"){
    msg.innerHTML=`
      üìé <a href="${msgData.fileData}" download="${msgData.fileName}" style="color:inherit;text-decoration:underline;">
      –°–∫–∞—á–∞—Ç—å ${msgData.fileName}
      </a>
      <div class="time">${msgData.time}</div>
    `;
  } else {
    // –ï—Å–ª–∏ –∞–≤–∞—Ç–∞—Ä–∞ –Ω–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–≤–∞–¥—Ä–∞—Ç–Ω—É—é –∑–∞–≥–ª—É—à–∫—É (rounded=false)
const avatarSrc = msgData.avatar || `https://ui-avatars.com/api/?name=${msgData.user}&background=random&rounded=false`;

msg.innerHTML = `
  <div style="display:flex; align-items:flex-start; gap:4px;">
    <img src="${avatarSrc}" class="msg-avatar">
    <div style="flex:1;">
      <div style="font-size:12px; color:white; font-weight:bold; margin-bottom:2px;">${msgData.user}</div>
      <div>${msgData.text}</div>
    </div>
  </div>
  <div class="time" style="text-align:right; margin-top:2px;">${msgData.time}</div>
`;
  }

  const messagesBox=document.getElementById("messages");
  messagesBox.appendChild(msg);
  // === Swipe delete logic ===
if(msgData.user === username){
  let startX = 0;
  let currentX = 0;
  let isSwiping = false;

  msg.addEventListener("touchstart", (e)=>{
    startX = e.touches[0].clientX;
    isSwiping = true;
    msg.classList.add("swiping");
  });

  msg.addEventListener("touchmove", (e)=>{
    if(!isSwiping) return;
    currentX = e.touches[0].clientX;
    const diff = currentX - startX;

    if(diff < 0){ // —Å–≤–∞–π–ø –≤–ª–µ–≤–æ
      msg.style.transform = `translateX(${diff}px)`;

      if(Math.abs(diff) > 80){
        msg.classList.add("delete-ready");
      } else {
        msg.classList.remove("delete-ready");
      }
    }
  });

  msg.addEventListener("touchend", ()=>{
    isSwiping = false;
    msg.classList.remove("swiping");

    if(Math.abs(currentX - startX) > 100){
      // —É–¥–∞–ª—è–µ–º –∏–∑ –±–∞–∑—ã
      remove(ref(database,"rooms/"+currentRoom+"/"+msgData.timestamp));
      msg.style.opacity = "0";
      setTimeout(()=>msg.remove(),200);
    } else {
      msg.style.transform = "translateX(0)";
      msg.classList.remove("delete-ready");
    }
  });
}
  // glow —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç –Ω–∞—Å
if(msgData.user !== username){
  msg.classList.add("new-glow");
  // –ª—ë–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö/PWA
if("vibrate" in navigator && msgData.user !== username){
  navigator.vibrate(10);
}
}
const isNearBottom =
  messagesBox.scrollHeight - messagesBox.scrollTop - messagesBox.clientHeight < 120;

// –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ù–ï –æ—Ç –Ω–∞—Å
if(msgData.user !== username){
  const isNearBottom = messagesBox.scrollHeight - messagesBox.scrollTop - messagesBox.clientHeight < 150;
  if(!isNearBottom){
    unreadCount++;
    document.getElementById("newMsgBadge").innerText = `–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (${unreadCount})`;
    document.getElementById("newMsgBadge").classList.add("show");
  } else {
    // –ï—Å–ª–∏ –º—ã –∏ —Ç–∞–∫ –≤–Ω–∏–∑—É, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
    messagesBox.scrollTop = messagesBox.scrollHeight;
  }
}

// –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –µ—Å–ª–∏ –º—ã –±–ª–∏–∑–∫–æ –∫ –Ω–∏–∑—É
if(isNearBottom){
  messagesBox.scrollTop = messagesBox.scrollHeight;
}

  // ===== –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ =====
  if(msgData.user === username){
    playSendSound();
  } else {
    playReceiveSound();
  }

// –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if(msgData.user !== username){
  // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ —Å–≤–µ—Ä–Ω—É—Ç–∞
  if(document.hidden && Notification.permission === "granted"){
    new Notification(`${msgData.user}`, {
      body: msgData.text || "–§–∞–π–ª",
      icon: '/icon-192.png' // –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∫–æ–Ω–∫—É –±—Ä–µ–Ω–¥–∞
    });
  }
}

if(messagesBox.children.length > 200){
  messagesBox.removeChild(messagesBox.firstChild);
}
}

/* ===== –û–¢–ü–†–ê–í–ö–ê ===== */
window.sendMessage=function(){
  if(Date.now() - lastSendTime < 500) return;
lastSendTime = Date.now();
  // —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ç—É—Å –ø–µ—á–∞—Ç–∞–µ—Ç
if(typingRef){
  set(ref(database,"rooms/"+currentRoom+"/typing/"+username), false);
}
  const input=document.getElementById("messageInput");
  if(input.value.trim()==="") return;
  const now=new Date();
  const timeString=now.getHours().toString().padStart(2,'0')+":"+now.getMinutes().toString().padStart(2,'0');
 push(ref(database,"rooms/"+currentRoom),{
  user:username,
  text:input.value,
  time:timeString,
  timestamp:Date.now(),
  avatar: userAvatar // –¥–æ–±–∞–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É
});
  input.value="";

};

/* ===== –§–ê–ô–õ–´ –í –ë–ê–ó–£ (–°–ö–ê–ß–ò–í–ê–ù–ò–ï) ===== */
document.getElementById("fileInput").addEventListener("change",(e)=>{
  const file = e.target.files[0];
  if(!file) return;

  // –æ–≥—Ä–∞–Ω–∏—á–∏–º —Ä–∞–∑–º–µ—Ä (—á—Ç–æ–±—ã –±–∞–∑–∞ –Ω–µ –≤–∑–æ—Ä–≤–∞–ª–∞—Å—å)
  if(file.size > 5 * 1024 * 1024){
    alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 5MB)");
    return;
  }

  const reader = new FileReader();

  reader.onload = function(event){
    push(ref(database,"rooms/"+currentRoom),{
      user:username,
      type:"file",
      fileName:file.name,
      fileData:event.target.result,
      time:new Date().toLocaleTimeString(),
      timestamp:Date.now()
    });
  };

  reader.readAsDataURL(file);
  e.target.value="";
});

// ===== –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–µ—á–∞—Ç–∏ (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –û–î–ò–ù —Ä–∞–∑) =====
document.getElementById("messageInput").addEventListener("input",()=>{

  if(!currentRoom) return;

  const userTypingRef = ref(database,"rooms/"+currentRoom+"/typing/"+username);

  set(userTypingRef,true);

  clearTimeout(typingTimeout);

  typingTimeout = setTimeout(()=>{
    set(userTypingRef,false);
  },2000);

});

document.getElementById("callButton").addEventListener("click", async () => {
  if(!currentRoom) return alert("–í—ã –Ω–µ –≤ –∫–æ–º–Ω–∞—Ç–µ");
  if(window.inCall) return alert("–í—ã —É–∂–µ –≤ –∑–≤–æ–Ω–∫–µ");

  const target = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–º—É —Ö–æ—Ç–∏—Ç–µ –ø–æ–∑–≤–æ–Ω–∏—Ç—å:");
  if(!target || target.trim() === "") return;

  await startCall(false, target.trim());
  showCallScreen(target.trim());
});

// ===== –ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ –∑–≤–æ–Ω–∫–∞ =====
function showCallScreen(peerName){
  document.getElementById("callWith").innerText = "–ó–≤–æ–Ω–æ–∫ —Å " + peerName;
  document.getElementById("callScreen").style.display = "flex";
}

function hangUp(){
  resetCall();
}

// ===== WebRTC –∑–≤–æ–Ω–æ–∫ =====
const peerConnections = {};
const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
let localStream = null;
let currentPC = null;
window.inCall = false;
let callRef = null;

async function startCall(isAnswer, peerName) {
  if (window.inCall) return;
  window.inCall = true;

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  const panel = document.getElementById("callPanel");
  panel.style.display = "flex";

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch(err) {
    alert("–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω");
    resetCall();
    return;
  }

  const pc = new RTCPeerConnection(config);
  currentPC = pc;

  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à –∑–≤—É–∫ –≤ –ø–æ—Ç–æ–∫
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  // –ö–æ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ–º –∑–≤—É–∫ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
  pc.ontrack = (e) => {
    let audio = document.getElementById("remoteAudio");
    if(!audio) {
      audio = document.createElement("audio");
      audio.id = "remoteAudio";
      audio.autoplay = true;
      document.body.appendChild(audio);
    }
    audio.srcObject = e.streams[0];
  };

  // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ–±–º–µ–Ω ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏ (—á—Ç–æ–±—ã –æ–±–∞ —Å–ª—ã—à–∞–ª–∏)
  pc.onicecandidate = (event) => {
    if(event.candidate) {
      // –ü–∏—à–µ–º –≤ –°–í–û–Æ –≤–µ—Ç–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
      push(ref(database, `rooms/${currentRoom}/ice/${username}_to_${peerName}`), event.candidate.toJSON());
    }
  };

  const iceRef = ref(database, `rooms/${currentRoom}/ice/${peerName}_to_${username}`);
  onChildAdded(iceRef, (snap) => {
    const candidate = snap.val();
    if(candidate && pc) pc.addIceCandidate(new RTCIceCandidate(candidate));
  });

  // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–æ–∫
  document.getElementById("muteBtn").onclick = () => {
    const audioTrack = localStream.getAudioTracks()[0];
    audioTrack.enabled = !audioTrack.enabled;
    
    // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
    const isMuted = !audioTrack.enabled;
    document.getElementById("muteBtn").innerText = isMuted ? "–í–∫–ª. –º–∏–∫" : "–ú—É—Ç";
    document.getElementById("muteBtn").style.background = isMuted ? "#555" : "#10a37f";

    // –°–æ–æ–±—â–∞–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É –æ –º—É—Ç–µ —á–µ—Ä–µ–∑ –±–∞–∑—É
    set(ref(database, `rooms/${currentRoom}/call/muteStatus/${username}`), isMuted);
};

  document.getElementById("hangupBtn").onclick = () => {
    resetCall();
  };

  // –°–∏–≥–Ω–∞–ª–ª–∏–Ω–≥ (Offer/Answer)
  const callDataRef = ref(database, `rooms/${currentRoom}/call`);
  // –°–ª—É—à–∞–µ–º, –Ω–µ –Ω–∞–∂–∞–ª –ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –º—É—Ç
const muteStatusRef = ref(database, `rooms/${currentRoom}/call/muteStatus/${peerName}`);
onValue(muteStatusRef, (snap) => {
    const isPeerMuted = snap.val();
    const statusEl = document.getElementById("callStatus");
    if (statusEl) {
        statusEl.innerText = isPeerMuted ? "–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤ –º—É—Ç–µ üîá" : "–ù–∞ —Å–≤—è–∑–∏";
        statusEl.style.color = isPeerMuted ? "#ef4444" : "white";
    }
});
  if (!isAnswer) {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    set(callDataRef, { from: username, to: peerName, sdp: offer, type: 'offer' });

    onValue(callDataRef, async (snap) => {
      const val = snap.val();
      if (val && val.type === 'answer' && val.to === username) {
        if (!pc.currentRemoteDescription) {
          await pc.setRemoteDescription(new RTCSessionDescription(val.sdp));
        }
      }
    });
  } else {
    const snap = await get(callDataRef);
    const data = snap.val();
    await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    set(callDataRef, { from: username, to: data.from, sdp: answer, type: 'answer' });
  }

  // –°–ª–µ–¥–∏–º –∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –∑–≤–æ–Ω–∫–∞ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
  onValue(callDataRef, (snap) => {
    if (!snap.exists() && window.inCall) {
      resetCall();
    }
  });
}

function resetCall() {
  ringtone.pause();
ringtone.currentTime = 0;
  window.inCall = false;
  
  // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
  const panel = document.getElementById("callPanel");
  if(panel) panel.style.display = "none";

if (currentRoom) {
    remove(ref(database, `rooms/${currentRoom}/call/muteStatus`));
}
  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
  if(localStream) {
    localStream.getTracks().forEach(track => track.stop());
    localStream = null;
  }

  // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
  if(currentPC) {
    currentPC.close();
    currentPC = null;
  }

  // –ß–∏—Å—Ç–∏–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
  if(currentRoom) {
    set(ref(database, `rooms/${currentRoom}/call`), null);
    set(ref(database, `rooms/${currentRoom}/ice/${username}_to_${currentTypingUser || 'peer'}`), null);
    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã
    remove(ref(database, `rooms/${currentRoom}/ice`));
  }

  // –£–¥–∞–ª—è–µ–º –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç
  const audio = document.getElementById("remoteAudio");
  if(audio) audio.remove();
}

</script>

<script>
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>{
    navigator.serviceWorker.register("/sw.js").then(()=>console.log("SW –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω")).catch(err=>console.log("–û—à–∏–±–∫–∞ SW:",err));
  });
}
window.addEventListener("offline", () => {
  alert("–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É");
});

window.addEventListener("online", () => {
  console.log("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
});
// === –ú–û–î–£–õ–¨ "–í–ï–ß–ù–´–ô –î–í–ò–ì–ê–¢–ï–õ–¨" ===

// 1. –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–µ—à–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.addEventListener("controllerchange", () => {
    // –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ–±–Ω–æ–≤–∏–ª—Å—è, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
    window.location.reload();
  });
}

// 2. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ (—á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ "–±–µ–ª–µ–ª–æ")
window.onerror = function(message, source, lineno, colno, error) {
  console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", message);
  // –ï—Å–ª–∏ —Å–ª—É—á–∏–ª–∞—Å—å –±–µ–¥–∞, –ø—Ä–æ–±—É–µ–º –º—è–≥–∫–æ –≤–µ—Ä–Ω—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å—Ç—Ä–æ–π —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
  if (message.includes("Firebase")) {
     console.warn("–ü—Ä–æ–±–ª–µ–º–∞ —Å –ë–î, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");
  }
  return false; 
};

// 3. –ü–∏–Ω–≥-–ø–æ–Ω–≥ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (Keep-Alive)
// –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –±—ã–ª–∞ –≤ —Ñ–æ–Ω–µ –¥–æ–ª–≥–æ, Firebase –º–æ–∂–µ—Ç —Ç–æ—Ä–º–æ–∑–∏—Ç—å –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible" && currentRoom) {
    // –§–æ—Ä—Å–∏—Ä—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
    const connectedRef = ref(database, ".info/connected");
    onValue(connectedRef, (snap) => {
      if (snap.val() === false) {
        console.log("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º...");
      }
    });
  }
});

// 4. –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –≤–∫–ª–∞–¥–∫–∏)
// –ï—Å–ª–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –æ—Ç–∫—Ä—ã—Ç –Ω–µ–¥–µ–ª—é, DOM-—ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–≥—É—Ç —Å–æ–∂—Ä–∞—Ç—å –ø–∞–º—è—Ç—å
setInterval(() => {
  const messagesBox = document.getElementById("messages");
  if (messagesBox && messagesBox.children.length > 300) {
    // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ DOM
    while (messagesBox.children.length > 100) {
      messagesBox.removeChild(messagesBox.firstChild);
    }
    console.log("–û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏: —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã –∏–∑ –≤–∏–¥–∏–º–æ—Å—Ç–∏");
  }
}, 60000 * 30); // –†–∞–∑ –≤ 30 –º–∏–Ω—É—Ç
const messagesBox = document.getElementById("messages");
const scrollDownBtn = document.getElementById("scrollDownBtn");

// –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–Ω–∏–∑—É
messagesBox.addEventListener("scroll", () => {
  const isNearBottom =
    messagesBox.scrollHeight - messagesBox.scrollTop - messagesBox.clientHeight < 100;

  if(!isNearBottom){
    scrollDownBtn.classList.add("show");
  } else {
    scrollDownBtn.classList.remove("show");
  }
});

// –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ‚Äî –ø–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
scrollDownBtn.addEventListener("click", () => {
  messagesBox.scrollTo({
    top: messagesBox.scrollHeight,
    behavior: "smooth"
  });
});
let unreadCount = 0;
const newMsgBadge = document.getElementById("newMsgBadge");

newMsgBadge.addEventListener("click", ()=>{
  messagesBox.scrollTo({
    top: messagesBox.scrollHeight,
    behavior: "smooth"
  });

  unreadCount = 0;
  newMsgBadge.classList.remove("show");
});
if(isNearBottom){
  unreadCount = 0;
  newMsgBadge.classList.remove("show");
}

</script>

</body>
</html>
