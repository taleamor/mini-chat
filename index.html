<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CoChat</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#10a37f">

<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background:#1c1c1c;
  color:white;
  display:flex;
  justify-content:center;
  height:100vh;
  overflow:hidden;
}

.container {
  width:100%;
  max-width:500px;
  height:100vh;
  display:flex;
  flex-direction:column;
  padding:14px;
  box-sizing:border-box;
}

h2,h3 { text-align:center; margin:8px 0; }

input {
  padding:12px;
  margin:6px 0;
  border-radius:12px;
  border:none;
  font-size:16px;
}

button {
  padding:14px;
  border:none;
  border-radius:12px;
  background:#10a37f;
  color:white;
  font-size:16px;
  cursor:pointer;
}

#messages {
  flex:1;
  overflow-y:auto;
  margin:10px 0;
  display:flex;
  flex-direction:column;
}

.message {
  max-width:80%;
  padding:10px 14px;
  border-radius:16px;
  margin:6px 0;
  font-size:15px;
  word-wrap:break-word;
}

.mine { align-self:flex-end; background:white; color:black; }
.other { align-self:flex-start; background:#10a37f; }

.time {
  font-size:11px;
  opacity:0.6;
  margin-top:4px;
}

#inputArea {
  display:flex;
  gap:6px;
}

#fileInputLabel, #callButton {
  width:48px;
  height:48px;
  font-size:22px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:12px;
}

#fileInputLabel { background:#10a37f; }
#callButton { background:#28a745; }

#messageInput {
  flex:1;
}

#fileInput { display:none; }

a.downloadLink {
  color:#fff;
  text-decoration:underline;
}
</style>
</head>
<body>

<div id="login" class="container">
  <h2>CoChat</h2>
  <input id="usernameInput" placeholder="–í–∞—à–µ –∏–º—è">
  <input id="roomInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã">
  <input id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="enterChat()">–í–æ–π—Ç–∏</button>
</div>

<div id="chat" class="container" style="display:none;">
  <h3 id="roomTitle"></h3>
  <div id="messages"></div>
  <div id="inputArea">
    <label id="fileInputLabel" for="fileInput">‚ûï</label>
    <input type="file" id="fileInput" accept="image/*,video/*">
    <input id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
    <button id="callButton">üìû</button>
    <button onclick="sendMessage()">‚û§</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, get, onValue } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = { /* —Ç–≤–æ–π –∫–æ–Ω—Ñ–∏–≥ –æ—Å—Ç–∞–≤—å —Ç–æ—Ç –∂–µ */ };

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentRoom="";
let username="";
const correctPassword="1234";

/* ===== –í–•–û–î ===== */
window.enterChat = function(){
  const room=document.getElementById("roomInput").value.trim();
  username=document.getElementById("usernameInput").value.trim();
  const pass=document.getElementById("passwordInput").value;

  if(pass!==correctPassword) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
  if(!room||!username) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ");

  currentRoom=room;

  document.getElementById("login").style.display="none";
  document.getElementById("chat").style.display="flex";
  document.getElementById("roomTitle").innerText=room;

  onChildAdded(ref(db,"rooms/"+room),(snap)=>{
    displayMessage(snap.val());
  });
};

/* ===== –û–¢–ü–†–ê–í–ö–ê –¢–ï–ö–°–¢–ê ===== */
window.sendMessage=function(){
  const input=document.getElementById("messageInput");
  if(!input.value.trim()) return;

  push(ref(db,"rooms/"+currentRoom),{
    type:"text",
    user:username,
    text:input.value,
    time:new Date().toLocaleTimeString()
  });

  input.value="";
};

/* ===== –û–¢–ü–†–ê–í–ö–ê –§–ê–ô–õ–ê ===== */
document.getElementById("fileInput").addEventListener("change",e=>{
  const file=e.target.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=function(ev){
    push(ref(db,"rooms/"+currentRoom),{
      type:"file",
      user:username,
      fileName:file.name,
      fileData:ev.target.result,
      time:new Date().toLocaleTimeString()
    });
  };
  reader.readAsDataURL(file);
});

/* ===== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï ===== */
function displayMessage(data){
  const msg=document.createElement("div");
  msg.className="message "+(data.user===username?"mine":"other");

  if(data.type==="text"){
    msg.innerHTML=`${data.text}<div class="time">${data.time}</div>`;
  }
  else if(data.type==="file"){
    msg.innerHTML=`
      üìé <a class="downloadLink" href="${data.fileData}" download="${data.fileName}">
      –°–∫–∞—á–∞—Ç—å ${data.fileName}
      </a>
      <div class="time">${data.time}</div>
    `;
  }

  const box=document.getElementById("messages");
  box.appendChild(msg);
  box.scrollTop=box.scrollHeight;
}

/* ===== WebRTC –ó–í–û–ù–û–ö (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π) ===== */
let localStream;
let pc;
const config={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

async function startCall(target){
  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  pc=new RTCPeerConnection(config);

  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));

  pc.ontrack=e=>{
    const audio=new Audio();
    audio.srcObject=e.streams[0];
    audio.play();
  };

  pc.onicecandidate=e=>{
    if(e.candidate){
      push(ref(db,"rooms/"+currentRoom+"/ice"),e.candidate.toJSON());
    }
  };

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);

  set(ref(db,"rooms/"+currentRoom+"/call"),{
    from:username,
    sdp:offer
  });
}

document.getElementById("callButton").onclick=()=>{
  startCall();
};
</script>
</body>
</html>
